{% extends 'base.html' %}
{% load bootstrap4 %}
{%  load static %}



{% block content %}
<div class="container">
    <h1 class="text-center">Status of machine</h1>
    <hr>
    <table class="table table-striped table-hover">
        <thead><tr>
            <th>#</th>
            <th>IP</th>
            <th>Machine No.</th>
            <th>Status</th>
            <th>Last-Check</th>
        </tr></thead>
        <tbody>
        {% for status in ls %}
            <tr>
            <td>{{ status.pk }}</td>
            <td>{{ status.machine.ip }}</td>
            <td>{{ status.machine.alias|default_if_none:status.machine.ip }}</td>
            <td id="status-{{ status.pk }}">{% if status.online == 0 %} <span class="badge badge-danger"><i class="fas fa-times-circle"></i> Offline</span>  {% else %}<span class="badge badge-success"><i class="fas fa-check-circle"></i> Online</span> {% endif %}</td>
            <th id="time-{{ status.pk }}">{{ status.updated_at }}</th>
            </tr>
        {% empty %}
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


{% block script %}
    <script>
    function checkStatus() {
        $.ajax({
            url: '{% url "tasks:machines_status" %}',
            type: 'get',
            success: function (res) {
                if (res.machines.length < 1){
                    return false
                }

                let st;
                let dom_status;
                let dom_time;

                for (let i=0; i < res.machines.length; i++){
                    st = res.machines[i];
                    dom_status = document.getElementById(`status-${st.id}`);
                    dom_time = document.getElementById(`time-${st.id}`);
                    if (dom_status !== null){
                        dom_time.innerText = st.time;
                        dom_status.innerHTML = st.status > 0 ? '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Online</span>' : '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Offline</span>'
                    }
                }
                return true
            }
        })
    }

    $(document).ready(function () {
        checkStatus();
        setInterval(function () {
            checkStatus();
        }, 2000);
    })
    </script>
{% endblock %}
